<!DOCTYPE html>
<html>
<head>
  <title>Vocabulary</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    a.word-link {
      color: blue;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Vocabulary List</h1>

  <!-- Form to Add New Word -->
  <form id="vocabForm">
    <input type="text" id="word" placeholder="Word" required />
    <input type="text" id="meaning" placeholder="Meaning" required />
    <input type="text" id="example" placeholder="Example Sentence" />
    <input type="password" id="personalAccessToken" placeholder="Your Personal Access Token" required />
    <button type="submit">Add Word</button>
  </form>

  <!-- Search Bar -->
  <input type="text" id="search" placeholder="Search words..." oninput="filterWords()" />

  <!-- Table to Display Vocabulary -->
  <table id="vocabularyTable">
    <thead>
      <tr>
        <th>Word</th>
        <th>Meaning</th>
        <th>Example</th>
      </tr>
    </thead>
    <tbody>
      <!-- Words will be dynamically added here -->
    </tbody>
  </table>

  <script>
    let vocabulary = [];

    // Fetch vocabulary.json and display it in a table
    fetch('vocabulary.json')
      .then(response => response.json())
      .then(data => {
        vocabulary = data;
        displayVocabulary(data);
      });

    function displayVocabulary(words) {
      const tableBody = document.getElementById('vocabularyTable').querySelector('tbody');
      tableBody.innerHTML = ''; // Clear previous content
      words.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="https://dictionary.cambridge.org/dictionary/english/${encodeURIComponent(entry.word)}" target="_blank" class="word-link">${entry.word}</a></td>
          <td>${entry.meaning}</td>
          <td>${entry.example || 'N/A'}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function filterWords() {
      const query = document.getElementById('search').value.toLowerCase();
      const filtered = vocabulary.filter(entry => entry.word.toLowerCase().includes(query));
      displayVocabulary(filtered);
    }

    // Handle form submission to add a new word
    document.getElementById('vocabForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const word = document.getElementById('word').value.trim();
      const meaning = document.getElementById('meaning').value.trim();
      const example = document.getElementById('example').value.trim();
      const token = document.getElementById('personalAccessToken').value.trim();

      // Check for duplicates
      if (vocabulary.some(entry => entry.word.toLowerCase() === word.toLowerCase())) {
        alert('This word already exists!');
        return;
      }

      if (!token) {
        alert('A Personal Access Token is required to submit a new word.');
        return;
      }

      // Add new word to vocabulary
      const newEntry = { word, meaning, example };
      vocabulary.push(newEntry);

      // Fetch current SHA of the file
      const fileResponse = await fetch('https://api.github.com/repos/darwin-xu/vocabulary/contents/vocabulary.json', {
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      });

      if (!fileResponse.ok) {
        alert('Error fetching file data. Please check your Personal Access Token.');
        return;
      }

      const fileData = await fileResponse.json();
      const updatedContent = btoa(JSON.stringify(vocabulary, null, 2)); // Base64 encode JSON

      // Update vocabulary.json on GitHub
      const updateResponse = await fetch('https://api.github.com/repos/darwin-xu/vocabulary/contents/vocabulary.json', {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: 'Add new word',
          content: updatedContent,
          sha: fileData.sha, // Required to update file
        }),
      });

      if (updateResponse.ok) {
        alert('Word added successfully!');
        displayVocabulary(vocabulary); // Update table
        document.getElementById('vocabForm').reset(); // Clear form
      } else {
        alert('Error updating the file. Please check your Personal Access Token.');
      }
    });
  </script>
</body>
</html>
